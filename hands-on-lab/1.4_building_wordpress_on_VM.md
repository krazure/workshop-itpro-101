# 1.4 Ubuntu 16.04 가상 컴퓨터에 Wordpress 설치

Azure에서는 가상 컴퓨터를 만들 때 정말 쉽게 만들 수 있도록 **생성시 모든 것을 만들 수 있도록** 되어있다. 하지만, 기본적으로 네트워크를 디자인하고, Log를 한 곳에 모으는 것 같이 아키텍처를 그리고 리소스를 만드려면 앞서 진행한 `1.1과 1.3`의 작업이 선행 되어야 보다 쉽게 아키텍처에 그려진 대로 서비스를 구축할 수 있다.

이번 내용에서는 Azure에 Ubuntu 16.04를 만들 때 가용성 집합을 사용하고 운영체제 디스크는 관리 디스크를 사용하여 만들어 본다. 가상 컴퓨터를 만든 후 Wordpress를 구성하는 스크립트를 실행한다.

가상 컴퓨터(VM)에 대해 좀 더 상세히 알아보고 싶으신 분은 [Azure Linux 가상 컴퓨터 문서](https://docs.microsoft.com/ko-kr/azure/virtual-machines/linux/)를 참고한다.

## Custom Script For Linux를 사용하는 Ubuntu 16.04 가상 컴퓨터 만들기

1. [Azure 웹 콘솔](https://portal.azure.com)에 접속한다.

2. 좌측 메뉴에서 **리소스 만들기**를 클릭한다.

3. **새로 만들기** 블레이드 창이 뜨면 상단의 검색창에 `ubuntu 16.04`를 입력한 후 엔트키를 입력한다.

4. 검색된 화면에서 `Ubuntu Server 16.04 LTS`를 찾아 클릭한다. 클릭하기 전 **게시자** 컬럼에 `Canonical`로 되어있는지 다시 한 번 확인하자.

5. **Ubuntu Server 16.04 LTS** 블레이드 창이 뜨면 가볍게 내용을 확인한 후 하단에 **배포 모델 선택**을 **Resource Manager**로 선택한 후 **만들기**버튼을 클릭한다.

6. **가상 머신 만들기** 블레이드 창이 뜨면 **기본 사항**탭에서 다음과 같이 입력한 후 **다음: 디스크**버튼을 클릭한다.
    - `구독` : 가상 컴퓨터를 생성할 구독을 선택한다.
    - `리소스 그룹` : 가상 컴퓨터를 만들 리소스 그룹을 선택한다. **기존 그룹 사용**을 선택한 후 앞서 생성한 `krazure-rg`를 선택한다.
    - `가상 머신 이름`: 표시 될 가상 컴퓨터 이름을 입력한다. 여기서는 `krazure-wp`를 입력한다.
    - `지역`: 가상 컴퓨터를 생성할 지역을 선택한다. 여기서는 `아시아 남동부`를 선택한다.
    - `가용성 옵션`: 가상 컴퓨터를 생성할 시 가용성 옵션을 선택한다. 가용성 옵션은 `가용성 영역`과 `가용성 집합`이 있으며 여기서는 `가용성 집합`을 선택한다.
    - `가용성 집합`: 가상 컴퓨터의 가용성 집합을 설정한다. 드롭 다운 메뉴 아래에 **새로 만들기**를 클릭한 후 오른쪽에 블레이드가 뜨면 아래와 같이 입력한 후 하단에 **확인**버튼을 클릭한다.
        - `이름`: 표시 될 가용성 집합의 이름을 입력한다. 여기서는 `krazure-as`로 입력한다.
        - `장애 도메인`: 설정할 장애 도메인의 개수 이다. 기본 값을 사용한다.
        - `업데이트 도메인`: 설정할 업데이트 도메인 이다. 기본 값을 사용한다.
        - `관리 디스크 사용`: 자동으로 설정된다.
            > [!메모]
            >
            > 가용성 집합은 관리 디스크의 사용 여부에 따라 다르게 적용된다. 예를 들어 가용성 집합이 관리 디스크를 사용하도록 설정한 후 만들게 되면, 관리 디스크를 사용하지 않는 가상 컴퓨터는 해당 가용성 집합에 포함 될 수 없다.
    - `이미지`: 가상 컴퓨터를 만들 때 사용할 이미지를 선택한다. `Ubuntu Server 16.04 LTS`가 선택되어 있는지 확인만 한다.
    - `크기`: 가상 컴퓨터를 만들 크기를 선택한다. **크기 변경**을 클릭한 후 오른쪽에 블레이드가 뜨면 `B1ms`를 검색하여 선택한 후 하단에 **확인**버튼을 클릭한다.
    - `인증 형식`: **SSH 공개 키** 또는 **암호**방식의 로그인을 선택한다. 여기서는 **SSH 공개 키**를 선택한다.
    - `사용자 이름`: Linux에 로그인 할 계정을 입력한다. 여기서는 `krazure`를 입력한다.
    - `SSH 공개 키`: 공개키 파일의 내용을 입력한다. SSH 공개키를 만드는 방법을 모르면 [여기](../source/key-pair/vm_publickey.pem)를 참고하여 공개키를 입력한다.
    - `Azure Active Directory를 사용하여 로그인(미리 보기)`: AAD 계정을 이용하여 OS에 로그인 하는 설정이다. 여기서는 **사용 안 함**을 선택한다.

7. **가상 머신 만들기** 블레이드 창의 **디스크**탭에서는 아무것도 수정하지 않고 **다음: 네트워킹**버튼을 클릭한다.

8. **가상 머신 만들기** 블레이드 창의 **네트워크**탭에서 다음과 같이 입력한 후 **다음: 관리**버튼을 클릭한다.
    - `가상 네트워크`: 가상 컴퓨터의 **네트워크 인터페이스**가 연결 될 가상 네트워크를 선택한다. 앞서 생성한 `krazure-vnet`을 선택한다.
    - `서브넷`: 가상 컴퓨터의 **네트워크 인터페이스**가 연결 될 서브넷를 선택한다. 앞서 생성한 `krazure-subnet`을 선택한다.
    - `공용 IP 주소`: Public IP가 필요할 시 설정한다. 여기서는 **새로 만들기**를 클릭한 후 오른쪽에 블레이드가 뜨면 다음과 같이 입력한 후 하단에 **확인**버튼을 클릭한다.
        - `이름`: 표시될 **공용 IP 주소**의 이름이다. 여기서는 `krazure-wp-ip`를 입력한다.
        - `SKU`: 공용 IP의 SKU를 선택한다. `가용성 영역`을 사용하지 않기 때문에 **기본**을 선택한다.
        - `할당`: 공용 IP를 동적으로 할당 받을지 정적으로 할당 받을지를 선택한다. 여기서는 **동적**으로 선택한다.
        > [!메모]
        >
        > **동적**할당은 가상 컴퓨터가 꺼졌다가 켜질 때 마다 공인 IP를 새롭게 받아온다.
        >
        > **정적**할당은 가상 컴퓨터가 꺼졌다가 켜지더라고 공인 IP가 변경되지 않는다.
    - `네트워크 보안 그룹`: 가상 컴퓨터의 네트워크 인터페이스에 연결될 **네트워크 보안 그룹**을 지정할 유형을 선택한다. 여기서는 **기본**을 선택한다.
    - `공용 인바운드 포트 선택`: 앞서 네트워크 보안 그룹을 **기본**으로 설정할 시 네트워크 보안 그룹을 쉽게 설정해 주는 옵션이다. 여기서는 **선택한 포트 허용**을 선택한다.
    - `인바운드 포트 선택`: 네트워크 보안 그룹에서 접근을 Any로 허용 할 Port를 선택한다. 드롭다운 메뉴를 클릭하여 **HTTP**와 __SSH (22)__ 의 체크박스에 체크를 한다.
    - `가속화된 네트워킹`: 네트워크 인터페이스의 높은 성능을 사용할 수 있는 옵션이다. 여기서는 **끄기**를 선택한다.

9. **가상 머신 만들기** 블레이드 창의 **관리**탭에서 다음과 같이 입력한 후 **다음: 게스트 구성**버튼을 클릭한다.
    - `부트 진단`: 가상 컴퓨터가 부팅될 때 로그를 생성할 수 있다. 실제 서비스 시에 해당 옵션이 꺼져 있으면 문제 추적에 어려움이 있을 수 있어 **켜는 것이 권장**이다. 여기서는 **끄기**를 선택한다.
    - `게스트 OS 진단`: 가상 컴퓨터의 운영체제의 문제에 대한 추적을 할 수 있도록 로그를 생성할 수 있다. 실제 서비스 시에 해당 옵션이 꺼져 있으면 문제 추적에 어려움이 있을 수 있어 **켜는 것이 권장**이다. 여기서는 **끄기**를 선택한다.
    - `시스템이 할당한 관리 ID`: Azure Key Vault과 같은 서비스를 사용하여 자격 증명을 거치지 않고 가상 컴퓨터를 제어할 수 있는 옵션이다. 여기서는 **끄기**를 선택한다.
    - `자동 종료 사용`: 가상 컴퓨터를 지정한 시각에 종료하는 추가 옵션이다. 여기서는 **끄기**를 선택한다.
    - `백업 사용`: 가상 컴퓨터를 백업하는 옵션이다. 여기서는 **끄기**를 선택한다.

10. **가상 머신 만들기** 블레이드 창의 **게스트 구성**탭에서 다음과 같이 입력한 후 **다음: 태그**버튼을 클릭한다.
    - `확장`: 가상 컴퓨터를 만들 때 사용할 확장 기능을 선택한다. 대부분이 제품을 설치하는 옵션이며, 최초 가상 컴퓨터 생성 시 실행해야 할 스크립트를 지정할 수 있다. 여기서는 확장 기능을 사용할 것이기 때문에 **설치할 확장 선택**을 클릭한 후 아래와 같은 작업을 진행한다.
        - 오른쪽에 `새 리소스`블레이드가 뜨면 **Custom Script For Linux**를 찾아 클릭한다.
        - **Custom Script For Linux** 블레이드가 추가로 뜨면 하단에 **만들기**버튼을 클릭한 후 아래와 같이 입력한 후 하단에 **확인**버튼을 클릭한다.
            - `Script files`: Linux에서 실행할 스크립트 파일을 첨부한다. [여기](https://raw.githubusercontent.com/krazure/workshop-itpro-101/master/source/script/script.sh)를 클릭한 후 웹 페이지가 뜨면 마우스 우클릭 -> 다른 이름으로 저장(A)...을 클릭하여 `script.sh` 파일로 저장하고, 저장한 `script.sh` 파일을 첨부한다.
            - `Command`: Linux에서 실행할 명령어를 입력한다. 앞서 `Script files`에서 지정한 파일을 실행하기 위해 `sh script.sh`를 입력한다.

11. **가상 머신 만들기** 블레이드의 **태그**탭에는 아무것도 수정하지 않고 하단의 **다음: 검토 + 만들기**를 클릭한다.

12. **가상 머신 만들기** 블레이드의 **검토 + 만들기**탭에서 상단에 `유효성 검사 통과`가 뜨면 생성 될 리소스의 정보를 확안한 후 하단의 **만들기**버튼을 클릭한다.
    > [!메모]
    >
    > 상단에 **유효성 검사 통과**가 나올 시 가상 컴퓨터를 생성할 수 있으며 만약 다른 메세지가 나오게 된다면 **제한 사항**에 문제가 있을 수 있다. **제한 사항**에 대해서는 다음 [URL](https://docs.microsoft.com/ko-kr/azure/azure-subscription-service-limits#networking-limits)을 참고한다.

    > [!메모]
    > 배포가 완료되는데 약 8분 50초가 소요된다. Custom Script 동작 시간이 약 6분 10초 정도이다.